#!/usr/bin/env python3

from datetime import datetime
import surfex
import numpy as np
import json


if __name__ == "__main__":


    #settings = json.load(open("/home/trygveasp/revision_control/offline-surfex-forcing/examples/settings/obs_input.json", "r"))
    #print(settings)
    #tests = json.load(open("/home/trygveasp/revision_control/offline-surfex-forcing/examples/settings/quality_control_input.json", "r"))
    #print(tests)

    settings = {
        't2m': {
            'set1': {
                'filepattern': '/home/trygveasp/surfex-tests/mc_ekf/airTemperatureAt2M.txt',
                'filetype': 'ASCII',
                'tests': {
                    'plausibility': {
                        'do_test': True,
                        'max': 280,
                        'min': 270
                    },
                    'sct': {
                        'do_test': False,
                        'passive': True,
                        "t2pos": 4,
                        "t2neg": 4,
                        "eps2": 0.5
                    },
                    'buddy': {

                    },
                    "climatology": {

                    }
                }
            },
            'set2': {
                'filepattern': '/home/trygveasp/surfex-tests/mc_ekf/airTemperatureAt2M.txt',
                'filetype': 'ASCII',
                'tests': {
                    'sct': {
                        'do_test': True,
                        "t2pos": 4,
                        "t2neg": 4,
                        "eps2": 0.5

                    },
                    'firstguess': {
                        "do_test": True,
                        "posdiff": 5,
                        "negdiff": 5
                    }
                }
            },
            'set3': {
                'filepattern': '/home/trygveasp/surfex-tests/mc_ekf/airTemperatureAt2M.txt',
                'filetype': 'ASCII',
                'tests':  {
                    'plausibility':  {
                        'do_test': True,
                        'max': 278,
                        'min': 272
                    },
                    'sct': {
                        'do_test': False,
                        'passive': True,
                        "t2pos": 4.0,
                        "t2neg": 4.0,
                        "eps2": 0.5
                    }
                }
            },
            "set4": {
                "filepattern": "not_used",
                "filenames": ["/lustre/storeA/project/metproduction/products/netatmo/2020/02/26/20200226T053501Z.json",
                              "/lustre/storeA/project/metproduction/products/netatmo/2020/02/26/20200226T054501Z.json"
                              ],
                "filetype": "netatmo",
                'tests': {
                    'plausibility': {
                        'do_test': True,
                        'max': 278,
                        'min': 272
                    },
                    'sct': {
                        'do_test': True,
                        'passive': False,
                        "t2pos": 4.0,
                        "t2neg": 4.0,
                        "eps2": 0.5
                    }
                }
            }
        },
        'sd': {

        }
    }

    test_flags = {"plausibility": 99, "firstguess": 4, "sct": 25, "climatology": 55, "buddy": 66}
    tests = ["plausibility", "climatology", "climatology",  "firstguess", "sct"]
    #tests = ["plausibility", "climatology", "buddy", "firstguess", "sct"],
    tests = ["sct"]
    obs_time = datetime.strptime("2020021600", "%Y%m%d%H")
    data_set = surfex.TitanDataSet("t2m", settings["t2m"], tests, test_flags, obs_time, debug=True)
    data_set.perform_tests()
    data_set.write_output("/tmp/obs.txt")

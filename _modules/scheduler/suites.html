
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>scheduler.suites &#8212; SURFEX Python API (pysurfex)  documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SURFEX Python API (pysurfex)  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">scheduler.suites</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for scheduler.suites</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ecflow</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>


<div class="viewcode-block" id="EcflowSuite"><a class="viewcode-back" href="../../index.html#scheduler.EcflowSuite">[docs]</a><span class="k">class</span> <span class="nc">EcflowSuite</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">def_file</span> <span class="o">=</span> <span class="n">def_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">get_var</span><span class="p">(</span><span class="s2">&quot;SFX_EXP_DATA&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecf_wd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">wd</span> <span class="o">+</span> <span class="s2">&quot;/ecf&quot;</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">get_var</span><span class="p">(</span><span class="s2">&quot;SFX_EXP_LIB&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># Date/time settings</span>
        <span class="n">ymd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">hh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enddate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtgend</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starthour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endhour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtgend</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hh_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_actual_hh_list</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hh_list</span><span class="p">)</span>

        <span class="c1"># Scheduler settings</span>
        <span class="n">ecf_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_var</span><span class="p">(</span><span class="s2">&quot;ECF_HOST&quot;</span><span class="p">)</span>
        <span class="n">rev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">rev</span>
        <span class="n">joboutdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">get_var</span><span class="p">(</span><span class="s2">&quot;JOBOUTDIR&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
        <span class="c1"># ecf_loghost = self.exp.server.get_var(&quot;ECF_LOGHOST&quot;)</span>
        <span class="c1"># ecf_logport = self.exp.server.get_var(&quot;ECF_LOGPORT&quot;)</span>

        <span class="n">ecf_include</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">+</span> <span class="s2">&quot;/ecf&quot;</span>
        <span class="n">ecf_files</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">+</span> <span class="s2">&quot;/ecf&quot;</span>
        <span class="n">ecf_home</span> <span class="o">=</span> <span class="n">joboutdir</span>
        <span class="n">ecf_out</span> <span class="o">=</span> <span class="n">joboutdir</span>
        <span class="n">ecf_jobout</span> <span class="o">=</span> <span class="n">joboutdir</span> <span class="o">+</span> <span class="s2">&quot;/</span><span class="si">%E</span><span class="s2">CF_NAME%.</span><span class="si">%E</span><span class="s2">CF_TRYNO%&quot;</span>
        <span class="n">ecf_job_cmd</span> <span class="o">=</span> <span class="s2">&quot;export PYTHONPATH=%LIB%/python-lib/:&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span> \
                      <span class="s2">&quot;%LIB%/python-lib/bin/ECF_submit -e </span><span class="si">%E</span><span class="s2">NSMBR% -ymd %YMD% -hh %HH% &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;</span><span class="si">%E</span><span class="s2">XP</span><span class="si">% %</span><span class="s2">LIB</span><span class="si">% %</span><span class="s2">ECF_NAME</span><span class="si">% %</span><span class="s2">ECF_TRYNO</span><span class="si">% %</span><span class="s2">ECF_PASS</span><span class="si">% -e</span><span class="s2">cf_rid </span><span class="si">%E</span><span class="s2">CF_RID% &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;&gt;&gt; %DATA%/ECF.log 2&gt;&amp;1&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defs</span> <span class="o">=</span> <span class="n">ecflow</span><span class="o">.</span><span class="n">Defs</span><span class="p">()</span>
        <span class="n">suite_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>
            <span class="n">suite_name</span> <span class="o">=</span> <span class="n">suite_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suite_name</span> <span class="o">=</span> <span class="n">suite_name</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="n">suite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">add_suite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suite_name</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;COMPLETE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;EXP&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;STREAM&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ARGS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENVT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;YMD&quot;</span><span class="p">,</span> <span class="n">ymd</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;HH&quot;</span><span class="p">,</span> <span class="n">hh</span><span class="p">)</span>
        <span class="c1"># suite.add_variable(&quot;Env_system&quot;, env_system)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;REV&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;PP&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR_STRING&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">enssize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">enssize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSSIZE&quot;</span><span class="p">,</span> <span class="n">enssize</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;WD&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">wd</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;DATA&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;LIB&quot;</span><span class="p">,</span> <span class="n">lib</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;SYSTEM&quot;</span><span class="p">,</span> <span class="n">lib</span> <span class="o">+</span> <span class="s2">&quot;/system.toml&quot;</span><span class="p">)</span>
        <span class="c1"># suite.add_variable(&quot;DTGBEG&quot;, self.progress.dtgbeg.strftime(&quot;%Y%m%d%H&quot;))</span>
        <span class="c1"># suite.add_variable(&quot;DTGEND&quot;, self.progressdtgend.strftime(&quot;%Y%m%d%H&quot;))</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;LBCN&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_EXTN&quot;</span><span class="p">,</span> <span class="s2">&quot;.py&quot;</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;SUBMISSION_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_HOST&quot;</span><span class="p">,</span> <span class="n">ecf_host</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_INCLUDE&quot;</span><span class="p">,</span> <span class="n">ecf_include</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_FILES&quot;</span><span class="p">,</span> <span class="n">ecf_files</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_TRIES&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_HOME&quot;</span><span class="p">,</span> <span class="n">ecf_home</span><span class="p">)</span>
        <span class="n">ecf_kill_cmd</span> <span class="o">=</span> <span class="s2">&quot;export PYTHONPATH=%LIB%/python-lib/:&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span> \
                       <span class="s2">&quot;%LIB%/python-lib/bin/ECF_kill </span><span class="si">%E</span><span class="s2">XP</span><span class="si">% %</span><span class="s2">LIB</span><span class="si">% %</span><span class="s2">ECF_NAME</span><span class="si">% %</span><span class="s2">ECF_PASS</span><span class="si">% %</span><span class="s2">ECF_TRYNO% &quot;</span> \
                       <span class="s2">&quot;-ecf_rid </span><span class="si">%E</span><span class="s2">CF_RID</span><span class="si">% -s</span><span class="s2">ubmission_id %SUBMISSION_ID%&quot;</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_KILL_CMD&quot;</span><span class="p">,</span> <span class="n">ecf_kill_cmd</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_OUT&quot;</span><span class="p">,</span> <span class="n">ecf_out</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_JOBOUT&quot;</span><span class="p">,</span> <span class="n">ecf_jobout</span><span class="p">)</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_JOB_CMD&quot;</span><span class="p">,</span> <span class="n">ecf_job_cmd</span><span class="p">)</span>
        <span class="c1"># suite.add_variable(&quot;ECF_LOGHOST&quot;, ecf_loghost)</span>
        <span class="c1"># suite.add_variable(&quot;ECF_LOGPORT&quot;, ecf_logport)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suite</span> <span class="o">=</span> <span class="n">suite</span>

    <span class="k">def</span> <span class="nf">set_actual_hh_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">hh_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_total_unique_hh_list</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hh_list</span><span class="p">)</span>

        <span class="n">actual_hh_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Check if the HHs are inside our time frame</span>
        <span class="k">for</span> <span class="n">hh</span> <span class="ow">in</span> <span class="n">hh_list</span><span class="p">:</span>
            <span class="n">this_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startdate</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">hh</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtg</span> <span class="o">&lt;=</span> <span class="n">this_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtgend</span><span class="p">:</span>
                <span class="n">actual_hh_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">this_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enddate</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">hh</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtg</span> <span class="o">&lt;=</span> <span class="n">this_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">dtgend</span><span class="p">:</span>
                    <span class="n">actual_hh_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span>

        <span class="c1"># print(actual_hh_list)</span>
        <span class="k">return</span> <span class="n">actual_hh_list</span>

    <span class="k">def</span> <span class="nf">save_as_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># self.defs.save_as_defs(self.def_file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">save_as_defs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">def_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;def filed saved to &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">def_file</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">SurfexTemplateSuite</span><span class="p">(</span><span class="n">EcflowSuite</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">EcflowSuite</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supervisor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_hour</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_cycle_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">climate_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observations_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_fam_hour</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_data_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_guess_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bufr2json_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fg_gridpp_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_surf_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">an_sfc_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perturbations_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecasting_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_fam_hour</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsmonitor_fam</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">create_init_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;InitRun&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_JOB_CMD&quot;</span><span class="p">,</span> <span class="s2">&quot;export PYTHONPATH=&quot;</span> <span class="o">+</span>
                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span>
                                   <span class="s2">&quot;</span><span class="si">%E</span><span class="s2">CF_JOB% &gt; </span><span class="si">%E</span><span class="s2">CF_JOBOUT%&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;SYSTEM&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">wd</span> <span class="o">+</span> <span class="s2">&quot;/system.toml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;STREAM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;LIB&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">wd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_INCLUDE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecf_wd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_FILES&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecf_wd</span><span class="p">)</span>

    <span class="c1"># Build family</span>
    <span class="k">def</span> <span class="nf">create_build_family</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Build</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">do_build</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Build&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
            <span class="n">utilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Utilities&quot;</span><span class="p">)</span>
            <span class="n">utilities</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Make_offline&quot;</span><span class="p">)</span>

            <span class="n">collect_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;CollectLogs&quot;</span><span class="p">)</span>
            <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
            <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete or &quot;</span> <span class="o">+</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == aborted)&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENVT&quot;</span><span class="p">,</span> <span class="s1">&#39;FROM=Build&#39;</span><span class="p">)</span>

    <span class="c1"># MakeCycleInput family</span>
    <span class="k">def</span> <span class="nf">create_make_cycle_input_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_ahead</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>

        <span class="n">cycle_input_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;MakeCycleInput&quot;</span><span class="p">)</span>
        <span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">add_repeat</span><span class="p">(</span><span class="n">ecflow</span><span class="o">.</span><span class="n">RepeatDate</span><span class="p">(</span><span class="s2">&quot;YMD&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startdate</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enddate</span><span class="p">)))</span>

        <span class="c1"># NB! self.pp_fam is not known yet. Must use Postprocessing as trigger</span>
        <span class="c1"># Maybe set triggers later when families are defined?</span>
        <span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &lt; ( Postprocessing:YMD + &quot;</span> <span class="o">+</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">days_ahead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s2">&quot; ) and &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">task_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">task_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">add_limit</span><span class="p">(</span><span class="s2">&quot;MCI&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">task_limit</span><span class="p">)</span>
                <span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">add_inlimit</span><span class="p">(</span><span class="s2">&quot;MCI&quot;</span><span class="p">)</span>

        <span class="n">ci_hour</span> <span class="o">=</span> <span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Hour&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ci_hour</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

        <span class="n">ci_hour</span><span class="o">.</span><span class="n">add_repeat</span><span class="p">(</span><span class="n">ecflow</span><span class="o">.</span><span class="n">RepeatEnumerated</span><span class="p">(</span><span class="s2">&quot;HH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hh_list</span><span class="p">))</span>
        <span class="n">ci_hour</span><span class="o">.</span><span class="n">add_complete</span><span class="p">(</span><span class="s2">&quot;((&quot;</span> <span class="o">+</span> <span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &lt;= &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span> <span class="o">+</span>
                             <span class="s2">&quot; and  (Hour:HH &lt; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">starthour</span> <span class="o">+</span> <span class="s2">&quot;)) or  ((&quot;</span> <span class="o">+</span>
                             <span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &gt;= &quot;</span> <span class="o">+</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">enddate</span> <span class="o">+</span> <span class="s2">&quot;) and (Hour:HH &gt; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">endhour</span> <span class="o">+</span> <span class="s2">&quot;)))&quot;</span><span class="p">)</span>

        <span class="n">ci_cycle_fam</span> <span class="o">=</span> <span class="n">ci_hour</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Cycle&quot;</span><span class="p">)</span>
        <span class="n">ci_cycle_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span> <span class="o">=</span> <span class="n">cycle_input_fam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_hour</span> <span class="o">=</span> <span class="n">ci_hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_cycle_fam</span> <span class="o">=</span> <span class="n">ci_cycle_fam</span>

    <span class="k">def</span> <span class="nf">make_cycle_input_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_hour</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;CollectLogs&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ci_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENVT&quot;</span><span class="p">,</span> <span class="s1">&#39;FROM=MakeCycleInput&#39;</span><span class="p">)</span>

    <span class="c1"># Date family</span>
    <span class="k">def</span> <span class="nf">create_date_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">date_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
        <span class="n">date_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">date_fam</span><span class="o">.</span><span class="n">add_repeat</span><span class="p">(</span><span class="n">ecflow</span><span class="o">.</span><span class="n">RepeatDate</span><span class="p">(</span><span class="s2">&quot;YMD&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startdate</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enddate</span><span class="p">)))</span>
        <span class="n">date_fam_hour</span> <span class="o">=</span> <span class="n">date_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Hour&quot;</span><span class="p">)</span>
        <span class="n">date_fam_hour</span><span class="o">.</span><span class="n">add_repeat</span><span class="p">(</span><span class="n">ecflow</span><span class="o">.</span><span class="n">RepeatEnumerated</span><span class="p">(</span><span class="s2">&quot;HH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hh_list</span><span class="p">))</span>
        <span class="n">date_fam_hour</span><span class="o">.</span><span class="n">add_complete</span><span class="p">(</span><span class="s2">&quot;((../Date:YMD &lt;= &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span> <span class="o">+</span>
                                   <span class="s2">&quot; and  (Hour:HH &lt; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">starthour</span> <span class="o">+</span> <span class="s2">&quot;)) or  ((../Date:YMD &gt;= &quot;</span> <span class="o">+</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">enddate</span> <span class="o">+</span> <span class="s2">&quot;) and (Hour:HH &gt; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">endhour</span> <span class="o">+</span> <span class="s2">&quot;)))&quot;</span><span class="p">)</span>
        <span class="n">date_cycle_fam</span> <span class="o">=</span> <span class="n">date_fam_hour</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Cycle&quot;</span><span class="p">)</span>

        <span class="c1"># Start Date if MakeCycleInput is complete</span>
        <span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="c1"># or if MakeCycleInput YMD is ahead of Date YMD</span>
        <span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &gt; &quot;</span> <span class="o">+</span>
                                        <span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># or if MakeCycleInput YMD is the same as Date YMD but MakeCycleInput HH is ahead of Date HH</span>
        <span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD == &quot;</span> <span class="o">+</span>
                                        <span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &quot;</span> <span class="o">+</span>
                                        <span class="s2">&quot;and &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH &gt; &quot;</span> <span class="o">+</span>
                                        <span class="n">date_fam_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH)&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># or if MakeCycleInput YMD is the same as Date YMD, and MakeCycleInput HH is the same as Date HH,</span>
        <span class="c1"># but we have met the needed dependencies</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD == &quot;</span> <span class="o">+</span> \
                  <span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &quot;</span> <span class="o">+</span> \
                  <span class="s2">&quot;and &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH == &quot;</span> <span class="o">+</span> \
                  <span class="n">date_fam_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH)&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations_fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot; and &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete &quot;</span>
        <span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">date_fam</span><span class="p">,</span> <span class="n">date_fam_hour</span><span class="p">,</span> <span class="n">date_cycle_fam</span>

    <span class="k">def</span> <span class="nf">date_loop_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">log_progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_fam_hour</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;LogProgress&quot;</span><span class="p">)</span>
        <span class="n">log_progress</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

        <span class="n">collect_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_fam_hour</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;CollectLogs&quot;</span><span class="p">)</span>
        <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENVT&quot;</span><span class="p">,</span> <span class="s1">&#39;FROM=Date&#39;</span><span class="p">)</span>
        <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == aborted&quot;</span><span class="p">)</span>
        <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">log_progress</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Postprocessing family</span>
    <span class="k">def</span> <span class="nf">create_post_processing_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">pp_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Postprocessing&quot;</span><span class="p">)</span>
        <span class="n">pp_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_run</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">pp_fam</span><span class="o">.</span><span class="n">add_repeat</span><span class="p">(</span><span class="n">ecflow</span><span class="o">.</span><span class="n">RepeatDate</span><span class="p">(</span><span class="s2">&quot;YMD&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startdate</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enddate</span><span class="p">)))</span>
        <span class="n">pp_fam_hour</span> <span class="o">=</span> <span class="n">pp_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Hour&quot;</span><span class="p">)</span>
        <span class="n">pp_fam_hour</span><span class="o">.</span><span class="n">add_repeat</span><span class="p">(</span><span class="n">ecflow</span><span class="o">.</span><span class="n">RepeatEnumerated</span><span class="p">(</span><span class="s2">&quot;HH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hh_list</span><span class="p">))</span>

        <span class="n">pp_fam_hour</span><span class="o">.</span><span class="n">add_complete</span><span class="p">(</span><span class="s2">&quot;((&quot;</span> <span class="o">+</span> <span class="n">pp_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &lt;= &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startdate</span> <span class="o">+</span>
                                 <span class="s2">&quot; and  (Hour:HH &lt; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">starthour</span> <span class="o">+</span> <span class="s2">&quot;)) or  ((&quot;</span> <span class="o">+</span>
                                 <span class="n">pp_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &gt;= &quot;</span> <span class="o">+</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">enddate</span> <span class="o">+</span> <span class="s2">&quot;) and (Hour:HH &gt; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">endhour</span> <span class="o">+</span> <span class="s2">&quot;)))&quot;</span><span class="p">)</span>
        <span class="n">pp_cycle_fam</span> <span class="o">=</span> <span class="n">pp_fam_hour</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Cycle&quot;</span><span class="p">)</span>
        <span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Start PP cycle if Date is complete</span>
        <span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="c1"># Start PP cycle if Date YMD is ahead of PP YMD</span>
        <span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &gt;  &quot;</span> <span class="o">+</span>
                                      <span class="n">pp_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Start PP cycle if Date YMD is the same but HH is ahead of PP HH</span>
        <span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD == &quot;</span> <span class="o">+</span>
                                      <span class="n">pp_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD and &quot;</span> <span class="o">+</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">date_fam_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH &gt; &quot;</span> <span class="o">+</span>
                                      <span class="n">pp_fam_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH)&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Start PP cycle if Date YMD is the same and date HH is the same but Forecasting is finished</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecasting_fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD == &quot;</span> <span class="o">+</span>
                                          <span class="n">pp_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD and &quot;</span> <span class="o">+</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">date_fam_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH == &quot;</span> <span class="o">+</span>
                                          <span class="n">pp_fam_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH  and &quot;</span> <span class="o">+</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">forecasting_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete)&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Set families in object</span>
        <span class="k">return</span> <span class="n">pp_fam</span><span class="p">,</span> <span class="n">pp_fam_hour</span><span class="p">,</span> <span class="n">pp_cycle_fam</span>

    <span class="k">def</span> <span class="nf">post_processing_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">disk_cleaning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_fam_hour</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Disk_cleaning&quot;</span><span class="p">)</span>
        <span class="n">disk_cleaning</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">disk_cleaning</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;SaniDisk&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;HOST1&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">disk_cleaning</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;SaniDisk_host1&quot;</span><span class="p">)</span>

        <span class="n">log_progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_fam_hour</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;LogProgress&quot;</span><span class="p">)</span>
        <span class="n">log_progress</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;PP&quot;</span><span class="p">,</span> <span class="s2">&quot;PP&quot;</span><span class="p">)</span>
        <span class="n">log_progress</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">log_progress</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">disk_cleaning</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">collect_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_fam_hour</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;CollectLogs&quot;</span><span class="p">)</span>
        <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">log_progress</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == aborted&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">disk_cleaning</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == aborted&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">collect_logs</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENVT&quot;</span><span class="p">,</span> <span class="s1">&#39;FROM=Postprocessing&#39;</span><span class="p">)</span>

    <span class="c1">#  Family Prepare_cycle</span>
    <span class="k">def</span> <span class="nf">create_prepare_cycle_family</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Prepare_cycle&quot;</span><span class="p">)</span>
        <span class="n">check_member_options</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check_member_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;CheckMemberOptions&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Prepare_cycle&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_member_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_task</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">check_member_options</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ecoclimap_sg</span><span class="p">:</span>
            <span class="n">prepare_param_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Prepare_param_bin&quot;</span><span class="p">)</span>
            <span class="n">prepare_param_bin</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_task</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">)):</span>
                <span class="n">mbr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:03}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">member</span><span class="p">])</span>
                <span class="n">fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Mbr&quot;</span> <span class="o">+</span> <span class="n">mbr</span><span class="p">)</span>
                <span class="n">fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_task</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
                <span class="n">fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Prepare_cycle&quot;</span><span class="p">)</span>
                <span class="n">fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">member</span><span class="p">])</span>
                <span class="n">fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR_STRING&quot;</span><span class="p">,</span> <span class="s2">&quot;_mbr&quot;</span> <span class="o">+</span> <span class="n">mbr</span><span class="p">)</span>

    <span class="c1"># Climate family</span>
    <span class="k">def</span> <span class="nf">create_climate_family</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">create_climate</span><span class="p">:</span>
            <span class="n">climate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Climate&quot;</span><span class="p">)</span>
            <span class="n">climate</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">climate_fam</span> <span class="o">=</span> <span class="n">climate</span>

            <span class="n">gmted_task</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gmted</span><span class="p">:</span>
                <span class="n">gmted_task</span> <span class="o">=</span> <span class="n">climate</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Prepare_gmted&quot;</span><span class="p">)</span>

            <span class="n">fams</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">)):</span>
                    <span class="n">mbr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:03}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">member</span><span class="p">])</span>
                    <span class="n">fam</span> <span class="o">=</span> <span class="n">climate</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Mbr&quot;</span> <span class="o">+</span> <span class="n">mbr</span><span class="p">)</span>
                    <span class="n">fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">member</span><span class="p">])</span>
                    <span class="n">fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR_STRING&quot;</span><span class="p">,</span> <span class="s2">&quot;_mbr&quot;</span> <span class="o">+</span> <span class="n">mbr</span><span class="p">)</span>
                    <span class="n">fams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fam</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">fams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">climate</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fam</span> <span class="ow">in</span> <span class="n">fams</span><span class="p">:</span>
                <span class="n">pgd_fam</span> <span class="o">=</span> <span class="n">fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;PGD&quot;</span><span class="p">)</span>

                <span class="n">pgd_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Pgd&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gmted_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pgd_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">gmted_task</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

    <span class="c1"># Observations family</span>
    <span class="k">def</span> <span class="nf">create_observations_family</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">need_obs</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observations_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Observations&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observations_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_task</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

            <span class="n">fams</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">)):</span>
                    <span class="n">mbr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:03}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">member</span><span class="p">])</span>
                    <span class="n">fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Mbr&quot;</span> <span class="o">+</span> <span class="n">mbr</span><span class="p">)</span>
                    <span class="n">fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">member</span><span class="p">])</span>
                    <span class="n">fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR_STRING&quot;</span><span class="p">,</span> <span class="s2">&quot;_mbr&quot;</span> <span class="o">+</span> <span class="n">mbr</span><span class="p">)</span>
                    <span class="n">fams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fam</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observations_fam</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fam</span> <span class="ow">in</span> <span class="n">fams</span><span class="p">:</span>
                <span class="n">prepare_ob</span> <span class="o">=</span> <span class="n">fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Prepare_ob&quot;</span><span class="p">)</span>
                <span class="n">prepare_ob</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare_cycle_task</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

    <span class="c1"># Startdata family</span>
    <span class="k">def</span> <span class="nf">create_startdata_family</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_data_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;StartData&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gridpp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fg_gridpp_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_data_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;FirstGuess4gridpp&quot;</span><span class="p">)</span>
            <span class="n">fg_gridpp_fa2grib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_gridpp_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;FirstGuessFA2grib&quot;</span><span class="p">)</span>
            <span class="n">fg_gridpp_fa2grib</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ARGS&quot;</span><span class="p">,</span> <span class="s2">&quot;his&quot;</span><span class="p">)</span>
            <span class="n">fg_gridpp_sfx_fa2grib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_gridpp_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;FirstGuessSfxFA2grib&quot;</span><span class="p">)</span>
            <span class="n">fg_gridpp_sfx_fa2grib</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ARGS&quot;</span><span class="p">,</span> <span class="s2">&quot;sfx&quot;</span><span class="p">)</span>
            <span class="n">fg_gridpp_oi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_gridpp_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;FirstGuessOI&quot;</span><span class="p">)</span>
            <span class="n">fg_gridpp_oi</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">fg_gridpp_fa2grib</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
            <span class="n">fg_gridpp_oi</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">fg_gridpp_sfx_fa2grib</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bufr2json_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_data_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Bufr2json&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_data_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Prep&quot;</span><span class="p">)</span>
        <span class="c1"># prep.add_trigger(self.first_guess_task.get_abs_node_path() + &quot; == complete&quot;)</span>

    <span class="c1"># Analysis family</span>
    <span class="k">def</span> <span class="nf">create_analysis_family</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mbr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Analysis&quot;</span><span class="p">)</span>

        <span class="c1"># self.analysis_fam.add_trigger(self.first_guess_task.get_abs_node_path() + &quot; == complete&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_ansfc_fam</span><span class="p">(</span><span class="n">mbr</span><span class="o">=</span><span class="n">mbr</span><span class="p">)</span>

    <span class="c1"># Surface assimilation</span>
    <span class="k">def</span> <span class="nf">create_ansfc_fam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mbr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">an_sfc_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;AnSFC&quot;</span><span class="p">)</span>
        <span class="n">an_prep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setting_is</span><span class="p">(</span><span class="s2">&quot;SURFEX#ASSIM#SCHEMES#ISBA&quot;</span><span class="p">,</span> <span class="s2">&quot;EKF&quot;</span><span class="p">,</span> <span class="n">mbr</span><span class="o">=</span><span class="n">mbr</span><span class="p">):</span>
            <span class="n">an_prep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">an_sfc_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;AnSFC_prep&quot;</span><span class="p">)</span>
            <span class="n">forcing</span> <span class="o">=</span> <span class="n">an_prep</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;OFFLINE_SURFEX_forcing&quot;</span><span class="p">)</span>
            <span class="n">hh_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_hh_list</span><span class="p">(</span><span class="n">mbr</span><span class="o">=</span><span class="n">mbr</span><span class="p">)</span>
            <span class="n">fcint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_fcint</span><span class="p">(</span><span class="n">hh_list</span><span class="p">)</span>
            <span class="n">forcing</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ARGS&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fcint</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 0&quot;</span><span class="p">)</span>
            <span class="n">offline</span> <span class="o">=</span> <span class="n">an_prep</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;OFFLINE_SURFEX&quot;</span><span class="p">)</span>
            <span class="n">offline</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">forcing</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
            <span class="n">perturbations</span> <span class="o">=</span> <span class="n">an_prep</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;EKF_SURFEX_perturbations&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pert</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">perts</span><span class="p">:</span>
                <span class="n">fam</span> <span class="o">=</span> <span class="n">perturbations</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;EKF_SURFEX_pert&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pert</span><span class="p">))</span>
                <span class="n">offline_pert</span> <span class="o">=</span> <span class="n">fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;OFFLINE_SURFEX&quot;</span><span class="p">)</span>
                <span class="n">offline_pert</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ARGS&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fcint</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pert</span><span class="p">))</span>

        <span class="n">interpol_ec_sst</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sst_from_ifs</span><span class="p">:</span>
            <span class="n">interpol_ec_sst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">an_sfc_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Interpol_ec_sst&quot;</span><span class="p">)</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;t2m&quot;</span><span class="p">,</span> <span class="s2">&quot;rh2m&quot;</span><span class="p">,</span> <span class="s2">&quot;sd&quot;</span><span class="p">]</span>
        <span class="n">oi_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gridpp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">an_sfc_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="n">qc</span> <span class="o">=</span> <span class="n">fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;QualityControl&quot;</span><span class="p">)</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ARGS&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufr2json_task</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;sd&quot;</span><span class="p">:</span>
                    <span class="n">qc</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg_gridpp_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">oi</span> <span class="o">=</span> <span class="n">fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;OptimalInterpolation&quot;</span><span class="p">)</span>
                <span class="n">oi</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">qc</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
                <span class="n">oi</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg_gridpp_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">oi</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ARGS&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                <span class="n">oi_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oi</span><span class="p">)</span>

            <span class="n">oi2soda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">an_sfc_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Oi2soda&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">oi_tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">oi2soda</span><span class="o">.</span><span class="n">get_trigger</span><span class="p">():</span>
                    <span class="n">oi2soda</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">oi</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">oi2soda</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">oi</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

            <span class="n">soda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">an_sfc_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Soda&quot;</span><span class="p">)</span>
            <span class="n">soda</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">oi2soda</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">interpol_ec_sst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">soda</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">interpol_ec_sst</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">an_prep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">soda</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">an_prep</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Perturbations family</span>
    <span class="k">def</span> <span class="nf">create_pertubations_family</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Perturbations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perturbations_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Perturbations&quot;</span><span class="p">)</span>

    <span class="c1"># Forecasting family</span>
    <span class="k">def</span> <span class="nf">create_forecasting_family</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forecasting_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Forecasting&quot;</span><span class="p">)</span>
        <span class="c1"># Build trigger</span>
        <span class="c1"># StarData complete</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_data_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete &quot;</span>
        <span class="c1"># Analysis complete</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot; and &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete &quot;</span>
        <span class="c1"># Trigger on perturbations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbations_fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot; and &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturbations_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete &quot;</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

        <span class="c1"># Trigger on boundaries (This cycle or if MakeCycleInput is ahead)</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot; and (&quot;</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete)&quot;</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot; or (&quot;</span>

        <span class="c1"># MakeCycleInput YMD is ahead of Date YMD</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &gt; &quot;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD)&quot;</span>

        <span class="c1"># MakeCycleInput YMD is the same as Date YMD but MakeCycleInput HH is ahead of Date HH</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot; or (&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD == &quot;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:YMD &quot;</span> <span class="o">+</span> <span class="s2">&quot;and &quot;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">ci_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH &gt; &quot;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">date_fam_hour</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:HH)&quot;</span>

        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot;))&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecasting_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forecasting_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Forecast&quot;</span><span class="p">)</span>

    <span class="c1"># Obsmonitor family</span>
    <span class="k">def</span> <span class="nf">create_obsmonitor_family</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mbr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">obsmon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Obsmonitor&quot;</span><span class="p">)</span>
        <span class="n">obsmon_statistics</span> <span class="o">=</span> <span class="n">obsmon</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;obsmon_statistics&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">multitask</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_sfc_analysis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;INITIAL_CONDITIONS#ANASURF&quot;</span><span class="p">,</span> <span class="n">mbr</span><span class="o">=</span><span class="n">mbr</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setting_is</span><span class="p">(</span><span class="s2">&quot;INITIAL_CONDITIONS#ANASURF&quot;</span><span class="p">,</span> <span class="s2">&quot;CANARI&quot;</span><span class="p">,</span> <span class="n">mbr</span><span class="o">=</span><span class="n">mbr</span><span class="p">):</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">obsmon_statistics</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;obsmon_stat_sfc&quot;</span><span class="p">)</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ODB_TYPE&quot;</span><span class="p">,</span> <span class="s2">&quot;ECMA&quot;</span><span class="p">)</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ARGS&quot;</span><span class="p">,</span> <span class="s2">&quot;sfc&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setting_is</span><span class="p">(</span><span class="s2">&quot;INITIAL_CONDITIONS#ANASURF&quot;</span><span class="p">,</span> <span class="s2">&quot;gridpp&quot;</span><span class="p">,</span> <span class="n">mbr</span><span class="o">=</span><span class="n">mbr</span><span class="p">):</span>
                    <span class="n">obsmon_statistics</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;QC2Obsmon&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_wrapup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wrapup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Wrapup&quot;</span><span class="p">)</span>
        <span class="n">wrapup</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_input_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">wrapup</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">wrapup</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SurfexSuite</span><span class="p">(</span><span class="n">SurfexTemplateSuite</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">SurfexTemplateSuite</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

        <span class="c1"># Init run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_init_run</span><span class="p">()</span>

        <span class="c1">#####################################################</span>
        <span class="c1"># Build</span>
        <span class="c1">#####################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_build_family</span><span class="p">()</span>

        <span class="c1">#####################################################</span>
        <span class="c1"># Start MakeCycleInput</span>
        <span class="c1">#####################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_make_cycle_input_loop</span><span class="p">(</span><span class="n">days_ahead</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Prepare_cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_prepare_cycle_family</span><span class="p">()</span>

        <span class="c1"># Create climate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_climate_family</span><span class="p">()</span>

        <span class="c1"># Observations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_observations_family</span><span class="p">()</span>

        <span class="c1">##################################################</span>
        <span class="c1"># Start Date</span>
        <span class="c1">##################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_fam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_fam_hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_date_loop</span><span class="p">()</span>

        <span class="n">old_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span>
        <span class="c1"># or ensemble dimension here</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mbr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">mbr</span><span class="p">]</span>
                <span class="n">member3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">member</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span> <span class="o">=</span> <span class="n">old_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Mbr&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">member3</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR_STRING&quot;</span><span class="p">,</span> <span class="s2">&quot;_mbr&quot;</span> <span class="o">+</span> <span class="n">member3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">member</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># StartData</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_startdata_family</span><span class="p">()</span>

            <span class="c1"># Analysis</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_analysis_family</span><span class="p">(</span><span class="n">mbr</span><span class="o">=</span><span class="n">member</span><span class="p">)</span>

            <span class="c1"># Pertubations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_pertubations_family</span><span class="p">()</span>

            <span class="c1"># Forecasting</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_forecasting_family</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">date_loop_finalize</span><span class="p">()</span>

        <span class="c1">##################################################</span>
        <span class="c1"># Start Postprocessing</span>
        <span class="c1">##################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_fam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_fam_hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_post_processing_loop</span><span class="p">()</span>

        <span class="n">old_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span>
        <span class="c1"># or ensemble dimension here</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mbr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">mbr</span><span class="p">]</span>
                <span class="n">member3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">member</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span> <span class="o">=</span> <span class="n">old_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Mbr&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">member3</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR&quot;</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pp_cycle_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENSMBR_STRING&quot;</span><span class="p">,</span> <span class="s2">&quot;_mbr&quot;</span> <span class="o">+</span> <span class="n">member3</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">create_obsmonitor_family</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">post_processing_finalize</span><span class="p">()</span>

        <span class="c1">###################################################</span>
        <span class="c1"># Wrapup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_wrapup</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SurfexTestbedSuite</span><span class="p">(</span><span class="n">SurfexTemplateSuite</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">):</span>
        <span class="n">SurfexTemplateSuite</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">)</span>

        <span class="n">testbed_configurations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;SYSTEM#TESTBED_LIST&quot;</span><span class="p">)</span>

        <span class="c1"># Init run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_init_run</span><span class="p">()</span>

        <span class="c1">#####################################################</span>
        <span class="c1"># Build</span>
        <span class="c1">#####################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_build_family</span><span class="p">()</span>

        <span class="c1"># Testbed</span>
        <span class="n">testbed_container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Testbed&quot;</span><span class="p">)</span>
        <span class="n">testbed_fam</span> <span class="o">=</span> <span class="n">testbed_container</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Testbed_cases&quot;</span><span class="p">)</span>
        <span class="n">testbed_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;SYSTEM&quot;</span><span class="p">,</span> <span class="s2">&quot;%LIB%/system.toml&quot;</span><span class="p">)</span>
        <span class="n">ecf_job_cmd</span> <span class="o">=</span> <span class="s2">&quot;export PYTHONPATH=&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">])</span> <span class="o">+</span> \
                      <span class="s2">&quot;:%LIB%/python-lib/; echo PYTHONPATH=$PYTHONPATH; &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;ECF_submit -c %COMPLETE</span><span class="si">% -e</span><span class="s2"> </span><span class="si">%E</span><span class="s2">NSMBR% -ymd %YMD% -hh %HH% -python&quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;%LIB%/system.toml </span><span class="si">%E</span><span class="s2">CF_NAME</span><span class="si">% %</span><span class="s2">ECF_TRYNO% &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;%LIB%/Env_submit -ecf_rid </span><span class="si">%E</span><span class="s2">CF_RID</span><span class="si">% -s</span><span class="s2">tream %STREAM% &gt;&gt; %DATA%/ECF.log 2&gt;&amp;1&quot;</span>
        <span class="n">testbed_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ECF_JOB_CMD&quot;</span><span class="p">,</span> <span class="n">ecf_job_cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">testbed_fam</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>

        <span class="n">started</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">testbed_configurations</span><span class="p">:</span>
            <span class="n">case_fam</span> <span class="o">=</span> <span class="n">testbed_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
            <span class="n">create_case</span> <span class="o">=</span> <span class="n">case_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Create_testbed_case&quot;</span><span class="p">)</span>
            <span class="n">case_fam</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;TESTBED_CASE&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
            <span class="n">start_case</span> <span class="o">=</span> <span class="n">case_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Start_testbed_case&quot;</span><span class="p">)</span>
            <span class="n">start_case</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">create_case</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">add_extern</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">conf</span><span class="p">)</span>
            <span class="n">started</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">conf</span><span class="p">)</span>

        <span class="n">collectlogs</span> <span class="o">=</span> <span class="n">testbed_container</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;CollectLogs&quot;</span><span class="p">)</span>
        <span class="n">collectlogs</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">testbed_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">collectlogs</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;ENVT&quot;</span><span class="p">,</span> <span class="s2">&quot;FROM=Testbed_cases&quot;</span><span class="p">)</span>

        <span class="c1">###################################################</span>
        <span class="c1"># Compare testbeds</span>
        <span class="n">finalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Finalize_testbed&quot;</span><span class="p">)</span>
        <span class="n">finalize</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">testbed_fam</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>
        <span class="n">compare_exps</span> <span class="o">=</span> <span class="n">finalize</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Testbed_comp&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">started</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">compare_exps</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">started</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; == complete or &quot;</span> <span class="o">+</span> <span class="n">started</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; == aborted)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compare_exps</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">started</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; == complete or &quot;</span> <span class="o">+</span>
                                              <span class="n">started</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; == aborted)&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TODO can not have 2 collectlogs on the same suite levels (with build)</span>
        <span class="c1"># collectlogs = self.suite.add_task(&quot;CollectLogs&quot;)</span>
        <span class="c1"># collectlogs.add_trigger(compare_exps.get_abs_node_path() + &quot; == complete&quot;)</span>
        <span class="c1"># collectlogs.add_variable(&quot;ENVT&quot;, &quot;FROM=Finalize_testbed&quot;)</span>

        <span class="c1"># Wrapup</span>
        <span class="n">wrapup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Wrapup&quot;</span><span class="p">)</span>
        <span class="n">wrapup</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">compare_exps</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; == complete&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SurfexSuite2</span><span class="p">(</span><span class="n">SurfexSuite</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">):</span>
        <span class="n">SurfexSuite</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">def_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecasting_fam</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Trygve&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_analysis_family</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mbr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_cycle_fam</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="s2">&quot;Trygve_does_not_like_analysis&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Sandbox</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">dtgs</span><span class="p">,</span> <span class="n">def_file</span><span class="p">,</span> <span class="n">dtgbeg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dtgbeg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtgbeg_str</span> <span class="o">=</span> <span class="n">dtgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtgbeg_str</span> <span class="o">=</span> <span class="n">dtgbeg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suite_name</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># self.defs = ecflow.Defs()</span>
        <span class="c1"># suite = self.defs.add_suite(suite_name)</span>

        <span class="n">ecf_files</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">wd</span> <span class="o">+</span> <span class="s2">&quot;/ecf&quot;</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">wd</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;ECF_FILES&quot;</span><span class="p">,</span> <span class="n">ecf_files</span><span class="p">),</span>
                     <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;LIB&quot;</span><span class="p">,</span> <span class="n">lib</span><span class="p">),</span>
                     <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;EXP&quot;</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                     <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;ECF_EXTN&quot;</span><span class="p">,</span> <span class="s2">&quot;.py&quot;</span><span class="p">),</span>
                     <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;SUBMISSION_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                     <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;DTG&quot;</span><span class="p">,</span> <span class="n">dtgbeg_str</span><span class="p">),</span>
                     <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;DTGBEG&quot;</span><span class="p">,</span> <span class="n">dtgbeg_str</span><span class="p">),</span>
                     <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;STREAM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                     <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suite</span> <span class="o">=</span> <span class="n">EcfSuite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suite_name</span><span class="p">,</span> <span class="n">def_file</span><span class="o">=</span><span class="n">def_file</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">)</span>
        <span class="c1"># suite = self.suite.ecf_node</span>

        <span class="n">init_run</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;InitRun&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="p">)</span>
        <span class="n">init_run_complete</span> <span class="o">=</span> <span class="n">EcfTrigger</span><span class="p">(</span><span class="n">init_run</span><span class="p">)</span>

        <span class="n">comp_trigger</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">(</span><span class="n">init_run_complete</span><span class="p">)</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="s2">&quot;Compilation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">comp_trigger</span><span class="p">)</span>

        <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;MakeOfflineBinaries&quot;</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>

        <span class="n">comp_complete</span> <span class="o">=</span> <span class="n">EcfTrigger</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span>
        <span class="n">static</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="s2">&quot;StaticData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">EcfTriggers</span><span class="p">([</span><span class="n">init_run_complete</span><span class="p">,</span> <span class="n">comp_complete</span><span class="p">]))</span>
        <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;Pgd&quot;</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>

        <span class="n">static_complete</span> <span class="o">=</span> <span class="n">EcfTrigger</span><span class="p">(</span><span class="n">static</span><span class="p">)</span>

        <span class="n">prep_complete</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hours_ahead</span> <span class="o">=</span> <span class="mi">24</span>
        <span class="n">cycle_input_dtg_node</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prediction_dtg_node</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">post_processing_dtg_node</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prev_dtg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">dtg</span> <span class="ow">in</span> <span class="n">dtgs</span><span class="p">:</span>
            <span class="n">dtg_str</span> <span class="o">=</span> <span class="n">dtg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H&quot;</span><span class="p">)</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;DTG&quot;</span><span class="p">,</span> <span class="n">dtg_str</span><span class="p">),</span>
                <span class="n">EcfVariable</span><span class="p">(</span><span class="s2">&quot;DTGBEG&quot;</span><span class="p">,</span> <span class="n">dtg_str</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">([</span><span class="n">init_run_complete</span><span class="p">,</span> <span class="n">static_complete</span><span class="p">])</span>

            <span class="n">dtg_node</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="n">dtg_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">)</span>

            <span class="n">ahead_trigger</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">dtg_str2</span> <span class="ow">in</span> <span class="n">prediction_dtg_node</span><span class="p">:</span>
                <span class="n">validtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dtg_str2</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">validtime</span> <span class="o">&lt;</span> <span class="n">dtg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">validtime</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours_ahead</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dtg</span><span class="p">:</span>
                        <span class="n">ahead_trigger</span> <span class="o">=</span> <span class="n">EcfTrigger</span><span class="p">(</span><span class="n">prediction_dtg_node</span><span class="p">[</span><span class="n">dtg_str2</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">ahead_trigger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">([</span><span class="n">init_run_complete</span><span class="p">,</span> <span class="n">static_complete</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">([</span><span class="n">init_run_complete</span><span class="p">,</span> <span class="n">static_complete</span><span class="p">,</span> <span class="n">ahead_trigger</span><span class="p">])</span>

            <span class="n">prepare_cycle</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;PrepareCycle&quot;</span><span class="p">,</span> <span class="n">dtg_node</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>

            <span class="n">triggers</span><span class="o">.</span><span class="n">add_triggers</span><span class="p">(</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">prepare_cycle</span><span class="p">))</span>

            <span class="n">cycle_input</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="s2">&quot;CycleInput&quot;</span><span class="p">,</span> <span class="n">dtg_node</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">)</span>
            <span class="n">cycle_input_dtg_node</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dtg_str</span><span class="p">:</span> <span class="n">cycle_input</span><span class="p">})</span>

            <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;Forcing&quot;</span><span class="p">,</span> <span class="n">cycle_input</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>

            <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">([</span><span class="n">init_run_complete</span><span class="p">,</span> <span class="n">static_complete</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">prev_dtg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prev_dtg_str</span> <span class="o">=</span> <span class="n">prev_dtg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H&quot;</span><span class="p">)</span>
                <span class="n">triggers</span><span class="o">.</span><span class="n">add_triggers</span><span class="p">(</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">prediction_dtg_node</span><span class="p">[</span><span class="n">prev_dtg_str</span><span class="p">]))</span>

            <span class="n">initialization</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="s2">&quot;Initialization&quot;</span><span class="p">,</span> <span class="n">dtg_node</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">)</span>

            <span class="n">analysis</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">dtg</span> <span class="o">==</span> <span class="n">dtgbeg</span><span class="p">:</span>

                <span class="n">prep</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;Prep&quot;</span><span class="p">,</span> <span class="n">initialization</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>
                <span class="n">prep_complete</span> <span class="o">=</span> <span class="n">EcfTrigger</span><span class="p">(</span><span class="n">prep</span><span class="p">)</span>
                <span class="c1"># Might need an extra trigger for input</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">schemes</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;SURFEX#ASSIM#SCHEMES&quot;</span><span class="p">)</span>
                <span class="n">do_soda</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="n">schemes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">schemes</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
                        <span class="n">do_soda</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">snow_ass</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;SURFEX#ASSIM#ISBA#UPDATE_SNOW_CYCLES&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snow_ass</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H&quot;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">snow_ass</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">hh</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">sn</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Do snow assimilation for &quot;</span><span class="p">,</span> <span class="n">dtg</span><span class="p">)</span>
                            <span class="n">do_soda</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">(</span><span class="n">prep_complete</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">do_soda</span><span class="p">:</span>
                    <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;CycleFirstGuess&quot;</span><span class="p">,</span> <span class="n">initialization</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fg</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;FirstGuess&quot;</span><span class="p">,</span> <span class="n">initialization</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>

                    <span class="n">an_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t2m&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;rh2m&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;sd&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                    <span class="n">nnco</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;SURFEX#ASSIM#OBS#NNCO&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnco</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">nnco</span><span class="p">[</span><span class="n">ivar</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">ivar</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">an_variables</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;t2m&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                            <span class="k">elif</span> <span class="n">ivar</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">an_variables</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rh2m&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                            <span class="k">elif</span> <span class="n">ivar</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                                <span class="n">an_variables</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;sd&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

                    <span class="n">analysis</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="s2">&quot;Analysis&quot;</span><span class="p">,</span> <span class="n">initialization</span><span class="p">)</span>
                    <span class="n">fg4oi</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;FirstGuess4OI&quot;</span><span class="p">,</span> <span class="n">analysis</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>

                    <span class="n">triggers</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">an_variables</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">an_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">analysis</span><span class="p">)</span>
                            <span class="n">qc</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;QualityControl&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                            <span class="n">oi_triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">([</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">qc</span><span class="p">),</span> <span class="n">EcfTrigger</span><span class="p">(</span><span class="n">fg4oi</span><span class="p">)])</span>
                            <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;OptimalInterpolation&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">oi_triggers</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>
                            <span class="n">triggers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

                    <span class="n">oi2soda_complete</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">(</span><span class="n">triggers</span><span class="p">)</span>
                        <span class="n">oi2soda</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;Oi2soda&quot;</span><span class="p">,</span> <span class="n">analysis</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">)</span>
                        <span class="n">oi2soda_complete</span> <span class="o">=</span> <span class="n">EcfTrigger</span><span class="p">(</span><span class="n">oi2soda</span><span class="p">)</span>

                    <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">([</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">fg</span><span class="p">),</span> <span class="n">oi2soda_complete</span><span class="p">])</span>
                    <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;Soda&quot;</span><span class="p">,</span> <span class="n">analysis</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>

            <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">([</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">cycle_input</span><span class="p">),</span> <span class="n">EcfTrigger</span><span class="p">(</span><span class="n">initialization</span><span class="p">)])</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="s2">&quot;Prediction&quot;</span><span class="p">,</span> <span class="n">dtg_node</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">)</span>
            <span class="n">prediction_dtg_node</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dtg_str</span><span class="p">:</span> <span class="n">prediction</span><span class="p">})</span>

            <span class="n">forecast</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;Forecast&quot;</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>
            <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;LogProgress&quot;</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">EcfTriggers</span><span class="p">(</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">forecast</span><span class="p">)),</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>

            <span class="n">pp</span> <span class="o">=</span> <span class="n">EcfFamily</span><span class="p">(</span><span class="s2">&quot;PostProcessing&quot;</span><span class="p">,</span> <span class="n">dtg_node</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">EcfTriggers</span><span class="p">(</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">prediction</span><span class="p">)))</span>
            <span class="n">post_processing_dtg_node</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dtg_str</span><span class="p">:</span> <span class="n">pp</span><span class="p">})</span>

            <span class="n">log_pp_trigger</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">analysis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">qc2obsmon</span> <span class="o">=</span> <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;Qc2obsmon&quot;</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>
                <span class="n">log_pp_trigger</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">(</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">qc2obsmon</span><span class="p">))</span>

            <span class="n">EcfTask</span><span class="p">(</span><span class="s2">&quot;LogProgressPP&quot;</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">log_pp_trigger</span><span class="p">,</span> <span class="n">ecf_files</span><span class="o">=</span><span class="n">ecf_files</span><span class="p">)</span>
            <span class="n">prev_dtg</span> <span class="o">=</span> <span class="n">dtg</span>

        <span class="n">hours_behind</span> <span class="o">=</span> <span class="mi">24</span>
        <span class="k">for</span> <span class="n">dtg</span> <span class="ow">in</span> <span class="n">dtgs</span><span class="p">:</span>
            <span class="n">dtg_str</span> <span class="o">=</span> <span class="n">dtg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H&quot;</span><span class="p">)</span>
            <span class="n">pp_dtg_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">dtg</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours_behind</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pp_dtg_str</span> <span class="ow">in</span> <span class="n">post_processing_dtg_node</span><span class="p">:</span>
                <span class="n">triggers</span> <span class="o">=</span> <span class="n">EcfTriggers</span><span class="p">(</span><span class="n">EcfTrigger</span><span class="p">(</span><span class="n">post_processing_dtg_node</span><span class="p">[</span><span class="n">pp_dtg_str</span><span class="p">]))</span>
                <span class="n">cycle_input_dtg_node</span><span class="p">[</span><span class="n">dtg_str</span><span class="p">]</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">triggers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_as_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">save_as_defs</span><span class="p">()</span>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../index.html#scheduler.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A Node class is the abstract base class for Suite, Family and Task</span>

<span class="sd">    Every Node instance has a name, and a path relative to a suite</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span> <span class="o">=</span> <span class="n">node_type</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;family&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecf_node</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">ecf_node</span><span class="o">.</span><span class="n">add_family</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecf_node</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">ecf_node</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;suite&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecf_node</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">add_suite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecf_node</span><span class="o">.</span><span class="n">get_abs_node_path</span><span class="p">()</span>
        <span class="n">triggers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;triggers&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;triggers&quot;</span><span class="p">]</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;variables&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecf_node</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">triggers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span> <span class="n">EcfTriggers</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">triggers</span><span class="o">.</span><span class="n">trigger_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecf_node</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">trigger_string</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Empty trigger&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Triggers must be a Triggers object&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span> <span class="o">=</span> <span class="n">triggers</span>

    <span class="k">def</span> <span class="nf">add_part_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggers</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span> <span class="n">EcfTriggers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">triggers</span><span class="o">.</span><span class="n">trigger_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecf_node</span><span class="o">.</span><span class="n">add_part_trigger</span><span class="p">(</span><span class="n">triggers</span><span class="o">.</span><span class="n">trigger_string</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Empty trigger&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Triggers must be a Triggers object&quot;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">NodeContainer</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Node</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="EcfSuite"><a class="viewcode-back" href="../../index.html#scheduler.EcfSuite">[docs]</a><span class="k">class</span> <span class="nc">EcfSuite</span><span class="p">(</span><span class="n">NodeContainer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defs</span> <span class="o">=</span> <span class="n">ecflow</span><span class="o">.</span><span class="n">Defs</span><span class="p">()</span>
        <span class="c1"># self.ecf_node = self.defs.add_suite(name)</span>

        <span class="n">def_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;def_file&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">def_file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;def_file&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">def_file</span> <span class="o">=</span> <span class="n">def_file</span>
        <span class="k">if</span> <span class="n">def_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">def_file</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.def&quot;</span>
        <span class="n">NodeContainer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;suite&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_as_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.defs.save_as_defs(self.def_file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">save_as_defs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">def_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;def filed saved to &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">def_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="EcfTriggers"><a class="viewcode-back" href="../../index.html#scheduler.EcfTriggers">[docs]</a><span class="k">class</span> <span class="nc">EcfTriggers</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;mode&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span>
        <span class="n">trigger_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_string</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_string</span> <span class="o">=</span> <span class="n">trigger_string</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_string</span><span class="p">(</span><span class="n">trigs</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">triggers</span> <span class="o">=</span> <span class="n">trigs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="p">[</span><span class="n">triggers</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="n">trigger</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">triggers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">mode</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">EcfTriggers</span><span class="p">):</span>
                    <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">trigger_string</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">EcfTrigger</span><span class="p">):</span>
                        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot; == &quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">mode</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Trigger must be a Trigger object&quot;</span><span class="p">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="c1"># If no triggers were found/set</span>
        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">trigger</span>

    <span class="k">def</span> <span class="nf">add_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggers</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;AND&quot;</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">mode</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">trigger_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_string</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trigger_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_string</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">trigger_string</span></div>


<div class="viewcode-block" id="EcfTrigger"><a class="viewcode-back" href="../../index.html#scheduler.EcfTrigger">[docs]</a><span class="k">class</span> <span class="nc">EcfTrigger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span></div>
        <span class="c1"># self.path = self.node.ecf_node.get_abs_path()</span>


<div class="viewcode-block" id="EcfVariable"><a class="viewcode-back" href="../../index.html#scheduler.EcfVariable">[docs]</a><span class="k">class</span> <span class="nc">EcfVariable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="EcfFamily"><a class="viewcode-back" href="../../index.html#scheduler.EcfFamily">[docs]</a><span class="k">class</span> <span class="nc">EcfFamily</span><span class="p">(</span><span class="n">NodeContainer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">NodeContainer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;family&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="EcfTask"><a class="viewcode-back" href="../../index.html#scheduler.EcfTask">[docs]</a><span class="k">class</span> <span class="nc">EcfTask</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Node</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ecf_files</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;ecf_files&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ecf_files</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ecf_files&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ecf_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Job should not be called default&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default_job</span> <span class="o">=</span> <span class="n">ecf_files</span> <span class="o">+</span> <span class="s2">&quot;/default.py&quot;</span>
                <span class="n">task_job</span> <span class="o">=</span> <span class="n">ecf_files</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">task_job</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">task_job</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">default_job</span> <span class="o">+</span> <span class="s2">&quot; - &gt; &quot;</span> <span class="o">+</span> <span class="n">task_job</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">default_job</span><span class="p">,</span> <span class="n">task_job</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SURFEX Python API (pysurfex)  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">scheduler.suites</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Trygve Aspelien.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>